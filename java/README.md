<div align="center">
    <img src="https://raw.githubusercontent.com/AlexanderJLiu/tensorflow-serving-api/master/images/java.png"
        width="200" height="200">
</div>

# Tensorflow Serving API for Java

## Prerequisites

### OpenJDK

1. For CentOS users, run the following commands:

   ```shell
   yum-config-manager --enable rhel-7-server-optional-rpms
   yum install java-11-openjdk-devel
   ```

2. For Ubuntu users, run the following command:

   ```shell
   apt-get install openjdk-11-jdk
   ```

3. Test your installation

   ```shell
   java -version
   ```

### Gradle

1. Gradle is used to manage `java` project.
2. Go to the release page of [gradle](https://gradle.org/releases/) and download the latest `gradle` binary-only or complete tarball.

   ```shell
   wget https://services.gradle.org/distributions/gradle-6.5.1-all.zip
   ```

3. Extract it into /usr/local, creating a gradle tree in /usr/local/gradle.

   ```shell
   unzip gradle-6.5.1-all.zip -d /usr/local
   ```

4. Add `/usr/local/gradle-6.5.1/bin` to the PATH environment variable. You can do this by adding this line to your `/etc/profile`.

   ```shell
   export PATH=$PATH:/usr/local/gradle-6.5.1/bin
   ```

5. Test your installation.

   ```shell
   gradle --version
   ```

### protoc

1. Protoc is used to compile protocol buffer files.
2. Go to the release page of [protobuf](https://github.com/protocolbuffers/protobuf/releases) and download the latest `protoc` binary tarball.

   ```shell
   wget https://github.com/protocolbuffers/protobuf/releases/download/v3.12.3/protoc-3.12.3-linux-x86_64.zip
   ```

3. Extract it into /usr/local, creating a protoc tree in /usr/local/protoc.

   ```shell
   unzip protoc-3.12.3-linux-x86_64.zip -d /usr/local/protoc
   ```

4. Add `/usr/local/protoc/bin` to the PATH environment variable. You can do this by adding this line to your `/etc/profile`.

   ```shell
   export PATH=$PATH:/usr/local/protoc/bin
   ```

5. Test your installation.

    ```shell
    protoc --version
    ```

### protoc-gen-grpc-java

1. `protoc-gen-grpc-java` is a plugin of protoc to generate `java` grpc files.
2. Run the following command to install the java protocol buffers grpc plugin.

   ```shell
   wget https://repo1.maven.org/maven2/io/grpc/protoc-gen-grpc-java/1.30.2/protoc-gen-grpc-java-1.30.2-linux-x86_64.exe
   ```

3. The compiler plugin protoc-gen-grpc-java must be in your `$PATH` for protoc to find it.

    ```shell
    mv protoc-gen-grpc-java-1.30.2-linux-x86_64.exe /usr/local/protoc/bin/protoc-gen-grpc-java
    ```

## Generate Java API File

### Swith to corresponding branch/tag

1. Clone this project to your local dir with the following command.

   ```shell
   git clone https://github.com/AlexanderJLiu/tensorflow-serving-api.git
   git submodule init
   git submodule update
   # or
   git clone --recurse-submodules https://github.com/AlexanderJLiu/tensorflow-serving-api.git
   ```

2. You should swith the source code of `tensorflow` and `serving` to the corresponding branch/tag when gengerating the java files.
3. Take version 2.2.0 as an example. Run the following commands to switch branch/tag.

   ```shell
   cd /path/to/tensorflow-serving-api/tensorflow
   git checkout tags/v2.2.0
   cd /path/to/tensorflow-serving-api/serving
   git checkout tags/2.2.0
   ```

### Generate java files

Run the following commands to generate java files to specific dir `java`.

```shell
cd /path/to/tensorflow-serving-api
protoc -I=serving -I=tensorflow --plugin=/usr/local/protoc/bin/protoc-gen-grpc-java --grpc-java_out=java --java_out=java serving/tensorflow_serving/*/*.proto
protoc -I=serving -I=tensorflow --plugin=/usr/local/protoc/bin/protoc-gen-grpc-java --grpc-java_out=java --java_out=java serving/tensorflow_serving/sources/storage_path/*.proto
```

In above commands, `-I` specify the directory in which to search for `proto imports`. And it can be specified multiple times. `--plugin` specific the grpc plugin used to generate java files. `--grpc-java_out` specific the directory in which to save java grpc files. `--java_out` specify the directory in which to save java proto files.

After executing the above commands, there will be one directory named `tensorflow` created in java dir. All the java files in `tensorflow/serving` dir have the same package name `tensorflow.serving`.

Because there already exists `proto-java` files of tensorflow, which can be found in [maven repository](https://mvnrepository.com/artifact/org.tensorflow/proto). So there is no need to generate it ourselves.

Also you can use the `gen.sh` script to generate tensorflow serving java files.

## Make a grpc request

1. Initialize a java application with gradle and name it `tensorflow-serving-api-java`.

    ```shell
    gradle init
    ```

2. Move the `tensorflow` directory generated by protoc to the `src/main/java` directory.
3. Modify the `build.gradle.kts` file and add the following `implementation` statements to the `dependencies`.

    ```ktolin
    dependencies {
        implementation("javax.annotation:javax.annotation-api:1.3.2") // jdk > 1.9
        implementation("com.google.protobuf:protobuf-java:3.12.2")
        implementation("org.tensorflow:proto:1.15.0")
        implementation("io.grpc:grpc-netty-shaded:1.30.2")
        implementation("io.grpc:grpc-protobuf:1.30.2")
        implementation("io.grpc:grpc-stub:1.30.2")
    }
    ```

4. Build the project to check if there is any errors.

   ```shell
   gradle build
   ```

5. Suppose I have a model named `first_model` served in tensorflow serving. Model metadata is shown as follows:

    ```shell
    $ curl http://localhost:8501/v1/models/first_model/versions/0/metadata
    {
        "model_spec": {
            "name": "first_model",
            "signature_name": "",
            "version": "0"
        },
        "metadata": {
            "signature_def": {
                "signature_def": {
                    "serving_default": {
                        "inputs": {
                            "input_1": {
                                "dtype": "DT_INT64",
                                "tensor_shape": {
                                    "dim": [
                                        {
                                            "size": "-1",
                                            "name": ""
                                        },
                                        {
                                            "size": "31",
                                            "name": ""
                                        }
                                    ],
                                    "unknown_rank": false
                                },
                                "name": "serving_default_input_1:0"
                            }
                        },
                        "outputs": {
                            "output_1": {
                                "dtype": "DT_FLOAT",
                                "tensor_shape": {
                                    "dim": [
                                        {
                                            "size": "-1",
                                            "name": ""
                                        },
                                        {
                                            "size": "1",
                                            "name": ""
                                        }
                                    ],
                                    "unknown_rank": false
                                },
                                "name": "StatefulPartitionedCall:0"
                            }
                        },
                        "method_name": "tensorflow/serving/predict"
                    },
                    "__saved_model_init_op": {
                        "inputs": {},
                        "outputs": {
                            "__saved_model_init_op": {
                                "dtype": "DT_INVALID",
                                "tensor_shape": {
                                    "dim": [],
                                    "unknown_rank": true
                                },
                                "name": "NoOp"
                            }
                        },
                        "method_name": ""
                    }
                }
            }
        }
    }
    ```

6. Then I use the code in `com/github/alex/App.java` to send a grpc request to the model above.

   ```shell
   gradle run
   ```

7. And the response is shown as follows:

    ```protobuf
    model_spec {
      name: "first_model"
      version {
      }
      signature_name: "serving_default"
    }
    inputs {
      key: "input_1"
      value {
        dtype: DT_INT64
        tensor_shape {
          dim {
              size: 1
          }
          dim {
              size: 31
          }
        }
        int64_val: 1
        ...
        int64_val: 1
      }
    }
  
    outputs {
      key: "output_1"
      value {
        dtype: DT_FLOAT
        tensor_shape {
          dim {
              size: 1
          }
          dim {
              size: 1
          }
        }
        float_val: 0.77852035
      }
    }
    model_spec {
      name: "first_model"
      version {
      }
      signature_name: "serving_default"
    }
    ```

## References

1. [Install OpenJDK on Windows and Linux](https://developers.redhat.com/openjdk-install/)
2. [Protocol Buffer Basics: Java](https://developers.google.com/protocol-buffers/docs/javatutorial)
3. [ProtoBuf: Java Generated Code](https://developers.google.com/protocol-buffers/docs/reference/java-generated)
4. [GRPC: Java Generated-code Reference](https://grpc.io/docs/languages/java/generated-code/)
